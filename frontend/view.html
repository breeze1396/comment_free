<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥çœ‹è¯„è®º - CommentFree</title>
    <link rel="stylesheet" href="style.css">
    <meta name="description" content="åœ¨CommentFreeä¸ŠæŸ¥çœ‹è¯„è®º">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘ï¸ æŸ¥çœ‹è¯„è®º</h1>
            <p>åˆ†äº«çš„å†…å®¹ï¼Œå…±åŒçš„å›å¿†</p>
        </div>
        
        <div class="content">
            <!-- å¯¼èˆªæ  -->
            <div style="text-align: center; margin-bottom: 30px;">
                <a href="index.html" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
                <a href="write.html" class="btn btn-primary">å†™è¯„è®º</a>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingDiv" class="hidden" style="text-align: center; padding: 40px;">
                <div class="loading" style="margin: 0 auto 20px;"></div>
                <p>æ­£åœ¨åŠ è½½è¯„è®º...</p>
            </div>
            
            <!-- é”™è¯¯æ¶ˆæ¯ -->
            <div id="errorMessage" class="hidden"></div>
            
            <!-- è¯„è®ºæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="commentDisplay" class="hidden"></div>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyState" class="hidden" style="text-align: center; padding: 40px;">
                <div style="font-size: 4em; margin-bottom: 20px;">ğŸ”</div>
                <h3 style="color: #667eea; margin-bottom: 15px;">æ²¡æœ‰æŒ‡å®šè¯„è®ºID</h3>
                <p style="color: #666; margin-bottom: 30px;">
                    è¯·åœ¨URLä¸­æ·»åŠ ?id=è¯„è®ºIDå‚æ•°ï¼Œæˆ–è€…è¿”å›é¦–é¡µæœç´¢è¯„è®º
                </p>
                <a href="index.html" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
            </div>
        </div>
        
        <div class="footer">
            <p>&copy; 2024 CommentFree. æ¯ä¸ªæƒ³æ³•éƒ½å€¼å¾—è¢«çœ‹è§.</p>
        </div>
    </div>
    
    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="imageModal" class="hidden" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        cursor: pointer;
    ">
        <div style="position: relative; max-width: 95%; max-height: 95%;">
            <img id="modalImage" style="
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            ">
            <button id="closeModal" style="
                position: absolute;
                top: -40px;
                right: 0;
                background: rgba(255, 255, 255, 0.9);
                border: none;
                border-radius: 50%;
                width: 32px;
                height: 32px;
                cursor: pointer;
                font-size: 18px;
                color: #333;
            ">Ã—</button>
        </div>
    </div>
    
    <script>
        let currentCommentId = '';
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
        
        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // ä»URLè·å–è¯„è®ºID
            const urlParams = new URLSearchParams(window.location.search);
            const commentId = urlParams.get('id');
            
            if (commentId) {
                currentCommentId = commentId;
                loadComment(commentId);
            } else {
                showEmptyState();
            }
            
            // åˆå§‹åŒ–æ¨¡æ€æ¡†äº‹ä»¶
            initializeModal();
        }
        
        // åŠ è½½è¯„è®º
        async function loadComment(commentId) {
            showLoading();
            
            try {
                const response = await fetch(`/api/view/${encodeURIComponent(commentId)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayComment(result.data);
                    updatePageTitle(result.data.id);
                } else {
                    showError(result.message || 'è¯„è®ºä¸å­˜åœ¨');
                }
            } catch (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            hideAllSections();
            document.getElementById('loadingDiv').classList.remove('hidden');
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            hideAllSections();
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.className = 'message error';
            errorDiv.textContent = message;
        }
        
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            hideAllSections();
            document.getElementById('emptyState').classList.remove('hidden');
        }
        
        // éšè—æ‰€æœ‰çŠ¶æ€åŒºåŸŸ
        function hideAllSections() {
            document.getElementById('loadingDiv').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('commentDisplay').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }
        
        // æ˜¾ç¤ºè¯„è®ºå†…å®¹
        function displayComment(data) {
            hideAllSections();
            
            const displayDiv = document.getElementById('commentDisplay');
            const createdAt = new Date(data.created_at).toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let imagesHtml = '';
            if (data.images && data.images.length > 0) {
                imagesHtml = `
                    <div class="post-images">
                        ${data.images.map(img => `
                            <div class="post-image">
                                <img src="/${img}" alt="è¯„è®ºå›¾ç‰‡" onclick="openImageModal('/${img}')" loading="lazy">
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            displayDiv.innerHTML = `
                <div class="post-container">
                    <div class="post-header">
                        <div class="post-id">ID: ${escapeHtml(data.id)}</div>
                        <div class="post-meta">
                            ğŸ“… ${createdAt} | 
                            ğŸ‘ï¸ ${data.view_count} æ¬¡æµè§ˆ | 
                            â¤ï¸ ${data.like_count} æ¬¡ç‚¹èµ
                        </div>
                    </div>
                    
                    <div class="post-content">${escapeHtml(data.content)}</div>
                    
                    ${imagesHtml}
                    
                    <div class="post-actions">
                        <button class="action-btn like-btn" onclick="likeComment('${escapeHtml(data.id)}')">
                            â¤ï¸ ç‚¹èµ (<span id="likeCount">${data.like_count}</span>)
                        </button>
                        <button class="action-btn" onclick="shareComment('${escapeHtml(data.id)}')">
                            ğŸ”— åˆ†äº«
                        </button>
                        <button class="action-btn" onclick="copyCommentId('${escapeHtml(data.id)}')">
                            ğŸ“‹ å¤åˆ¶ID
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e8ecf4; text-align: center;">
                        <a href="write.html" class="btn btn-primary" style="margin-right: 10px;">
                            âœï¸ æˆ‘ä¹Ÿè¦å†™è¯„è®º
                        </a>
                        <a href="index.html" class="btn btn-secondary">
                            ğŸ  è¿”å›é¦–é¡µ
                        </a>
                    </div>
                </div>
            `;
            
            displayDiv.classList.remove('hidden');
        }
        
        // ç‚¹èµè¯„è®º
        async function likeComment(commentId) {
            try {
                const response = await fetch(`/api/like/${encodeURIComponent(commentId)}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    // æ›´æ–°ç‚¹èµæ•°
                    const likeCountElement = document.getElementById('likeCount');
                    if (likeCountElement) {
                        const currentCount = parseInt(likeCountElement.textContent);
                        likeCountElement.textContent = currentCount + 1;
                    }
                    
                    // æ·»åŠ ç‚¹èµåŠ¨ç”»æ•ˆæœ
                    const likeBtn = document.querySelector('.like-btn');
                    if (likeBtn) {
                        likeBtn.classList.add('liked');
                        
                        // æ˜¾ç¤ºç‚¹èµæˆåŠŸæç¤º
                        showToast('ğŸ‘ ç‚¹èµæˆåŠŸï¼');
                        
                        // 1ç§’åç§»é™¤æ ·å¼
                        setTimeout(() => {
                            likeBtn.classList.remove('liked');
                        }, 1000);
                    }
                } else {
                    showToast('âŒ ç‚¹èµå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç‚¹èµå¤±è´¥:', error);
                showToast('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // åˆ†äº«è¯„è®º
        async function shareComment(commentId) {
            const url = `${window.location.origin}/view.html?id=${encodeURIComponent(commentId)}`;
            
            try {
                if (navigator.share) {
                    // ä½¿ç”¨Web Share API
                    await navigator.share({
                        title: `CommentFree - è¯„è®º ${commentId}`,
                        text: 'æŸ¥çœ‹è¿™æ¡æœ‰è¶£çš„è¯„è®º',
                        url: url
                    });
                } else {
                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    await navigator.clipboard.writeText(url);
                    showToast('ğŸ”— é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }
            } catch (error) {
                console.error('åˆ†äº«å¤±è´¥:', error);
                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ˜¾ç¤ºåˆ†äº«é“¾æ¥
                prompt('å¤åˆ¶ä¸‹é¢çš„é“¾æ¥æ¥åˆ†äº«è¿™æ¡è¯„è®º:', url);
            }
        }
        
        // å¤åˆ¶è¯„è®ºID
        async function copyCommentId(commentId) {
            try {
                await navigator.clipboard.writeText(commentId);
                showToast('ğŸ“‹ è¯„è®ºIDå·²å¤åˆ¶');
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                prompt('å¤åˆ¶è¯„è®ºID:', commentId);
            }
        }
        
        // æ˜¾ç¤ºtoastæç¤º
        function showToast(message, type = 'success') {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#e74c3c' : '#28a745'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 1001;
                font-weight: 500;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // åˆå§‹åŒ–å›¾ç‰‡æ¨¡æ€æ¡†
        function initializeModal() {
            const modal = document.getElementById('imageModal');
            const closeBtn = document.getElementById('closeModal');
            
            // ç‚¹å‡»å…³é—­æŒ‰é’®
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeImageModal();
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            modal.addEventListener('click', closeImageModal);
            
            // ESCé”®å…³é—­
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeImageModal();
                }
            });
        }
        
        // æ‰“å¼€å›¾ç‰‡æ¨¡æ€æ¡†
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = src;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
        }
        
        // å…³é—­å›¾ç‰‡æ¨¡æ€æ¡†
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
        }
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜
        function updatePageTitle(commentId) {
            document.title = `è¯„è®º ${commentId} - CommentFree`;
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ç›‘å¬æµè§ˆå™¨åé€€/å‰è¿›
        window.addEventListener('popstate', function(event) {
            initializePage();
        });
    </script>
</body>
</html>